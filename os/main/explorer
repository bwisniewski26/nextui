local function s(...) return sleep(...) end
local function aw(...) return write(...) end
local function p(...) return print(...) end
local function tw(...) return term.write(...) end
local function scp(...) return term.setCursorPos(...) end
local function sbc(...) return term.setBackgroundColor(...) end
local function stc(...) return term.setTextColor(...) end
local function tc(...) return term.clear(...) end
local function tcl(...) return term.clearLine(...) end
local function r(...) return shell.run(...) end
local function sp(...) return textutils.slowPrint(...) end
local function sw(...) return textutils.slowWrite(...) end
local function fse(...) return fs.exists(...) end
local function pul(...) return paintutils.loadImage(...) end
local function pud(...) return paintutils.drawImage(...) end
local function pfb(...) return paintutils.drawFilledBox(...) end
local function su(...) return os.shutdown(...) end
local function re(...) return os.reboot(...) end
local function pdp(...) return paintutils.drawPixel(...) end

args = {...}

local function errorHandler(programPath)
    local file = fs.open(programPath, "r")
    if not file then
        print("Error opening program file.")
		s(1)
        return
    end

    local programCode = file.readAll()
    file.close()

    local programFunction, loadError = load(programCode)
    if not programFunction then
        print("Error loading program:")
        print(loadError)
		s(2)
        return
    end

    local success, runError = pcall(programFunction)
    if not success then
        print("Error running program:")
        print(runError)
		s(2)
    end
end


function wyswietl_pliki(sciezka, y)
	sbc(colors.black)
	tc()
	sbc(colors.black)
	stc(colors.white)
	scp(1,1)
	if pocket then p("< Obecna sciezka: ", fs.getDir(sciezka), sciezka) else p("< NextExplorer 1.0. Obecna sciezka: ", fs.getDir(sciezka), sciezka) end
	scp(w,1)
	p("X")
	local files = fs.list(sciezka)
	for i,file in ipairs(files) do
		scp(2,y)
		if fs.isDir(fs.combine(sciezka,file)) then
			if fs.isDir(fs.combine(sciezka,file)) == "os/main/" then
				stc(colors.red)
				term.write("[["..file.."]]")
				stc(colors.white)
			end
			stc(colors.yellow)
			term.write("[["..file.."]]")
			stc(colors.white)
		else
			if sciezka == "os/main" then stc(colors.red) end
			term.write(file)
			stc(colors.white)
		end
	y = y+1
	end
	scp(1,h)
	write("Plik  Pomoc")
end

function wyswietl_foldery(sciezka, y)
	local files = fs.list(sciezka)
	for i,file in ipairs(files) do
		scp(2,y)
		if fs.isDir(fs.combine(sciezka,file)) then
			stc(colors.yellow)
			term.write("[["..file.."]]")
			stc(colors.white)
		end
	y = y+1
	end
end

function foldery(sciezka)
arg = {}
local files = fs.list(sciezka)
y = 1
for i,file in ipairs(files) do
    if fs.isDir(fs.combine(sciezka,file)) then
		arg[y] = file
    	y = y+1
	end
end
a = 1
scp(1,10)
arg[y+1] = y
return arg
end

function pliki(sciezka)
arg = {}
local files = fs.list(sciezka)
y = 1
for i,file in ipairs(files) do
	arg[y] = file
	y = y+1
end
a = 1
scp(1,10)
arg[y+1] = y
return arg
end

function mysz()
 local event, button, x, y = os.pullEvent("mouse_click")
klik = {x, y, button}
return klik
end

function ile_folderow(sciezka)
local files = fs.list(sciezka)
ile = 0
for i,file in ipairs(files) do
	if fs.isDir(fs.combine(sciezka,file)) then
			ile = ile+1
	end
end
return ile
end


function ile_plikow(sciezka)
local files = fs.list(sciezka)
ile = 0
for i,file in ipairs(files) do
	ile = ile+1
end
return ile
end

function plik(sciezka)
while true do
pfb(1,h-6,15,h-1,colors.gray)
pdp(15,h-6,colors.red)
stc(colors.white)
sbc(colors.gray)
	w, h = term.getSize()
	shell.setDir(sciezka)
	scp(1,h-6)
	write[[Nowy plik
Nowy folder
Usun
Idz
Kopiuj]]
	klik = mysz()
	if (klik[1]>0 and klik[1]<14 and klik[2]==h-6) then
		scp(1,2)
		write("Podaj nazwe pliku: ")
		nazwa = read()
		shell.run("edit", nazwa)
		break
	end
	if (klik[1]>0 and klik[1]<15 and klik[2]==h-5) then
		scp(1,2)
		write("Podaj nazwe pliku: ")
		nazwa = read()
		shell.run("mkdir", nazwa)
		break
	end
	if (klik[1]>0 and klik[1]<15 and klik[2]==h-4) then
		scp(1,2)
		write("Podaj nazwe pliku: ")
		nazwa = read()
		scp(1,h-6)
		write("Czy na pewno? Wpisz Y aby kontynuowac: ")
		usun = read()
		if (usun == "Y") then fs.delete(nazwa) end
		break
	end
	if (klik[1]>0 and klik[1]<15 and klik[2]==h-3) then
		scp(1,2)
		write("Podaj nowa sciezke: ")
		nowa_sciezka = read()
		if fse(fs.combine(sciezka,nowa_sciezka)) then
			main(nowa_sciezka)
		end
		break
	end
	if (klik[1]>0 and klik[1]<15 and klik[2]==h-2) then
		scp(1,2)
		write("Podaj nazwe pliku: ")
		plik_kopiuj = read()
		write("Podaj nowa sciezke: ")
		nowa_sciezka = read()
		if fs.exists(plik_kopiuj) then
			fs.copy(plik_kopiuj, fs.combine(nowa_sciezka,plik_kopiuj))
		end
		break
	end
	if (klik[1] == 15 and klik[2] == h-6) then
		sbc(colors.black)
		stc(colors.white)
		break
	end
end
end

function pomoc(sciezka)
	tc()
	w, h = term.getSize()
	scp(w,1)
	p("X")
	scp(1,2)
print[[
Witamy w NextExplorer 1.0!
Podstawowe sterowanie programem:
- lewy przycisk myszy - wejscie do katalogu/wykonanie pliku
- prawy przycisk myszy - edycja wskazanego pliku
- Zakladka Plik - tworzenie/usuwanie plikow/folderow
- znak < - cofniecie do poprzedniego katalogu
- znak X - wyjscie z programu/zamkniecie zakladki
]]
klik = mysz()
if (klik[1] == w and klik[2] == 1) then main(sciezka) end
end


function main(sciezka) 
while true do
shell.setDir(sciezka)
w, h = term.getSize()
		wyswietl_pliki(sciezka, 3)
		arg = pliki(sciezka)
		ile = ile_plikow(sciezka)
		
		klik = mysz()
		klik_y = klik[2]-2
		if (klik[1]>0 and klik[1]<5 and klik[2] == h) then
			plik(sciezka)
		end
		if (klik[1]>5 and klik[1]<9 and klik[2] == h) then
			pomoc(sciezka)
		end
		if (klik[1] == w and klik[2] == 1) then error() end
		if (klik[1] == 1 and klik[2] == 1) then
			sciezka = fs.getDir(sciezka)
			if (sciezka == "") then sciezka = "/" end
			break
		end
		if (klik[1]>0 and klik[1]<w and klik_y<ile+1 and klik_y>0 and klik[3] == 2) then
			if fs.exists(fs.combine(sciezka,arg[klik_y])) then
				if sciezka == "os/main" then
				tc()
				pfb(1,1,w,h,colors.black)
				stc(colors.red)
				scp(1,1)
				p[[UWAGA!]]
				stc(colors.white)
p[[Zamierzasz edytowac plik systemowy NextUI 2.0. Najdrobniejsza zmiana moze spowodowac nieodwracalne zmiany w dzialaniu systemu na Twoim komputerze i wymusi ponowna instalacje systemu. Przed wprowadzeniem swojego kodu upewnij sie, ze wiesz co robisz. W przeciwnym wypadku NATYCHMIAST opusc edytor tekstu bez wprowadzania zmian.]]
s(3)
end
				shell.run("/os/luaide", arg[klik_y])
			end
		end
		if (klik[1]>0 and klik[1]<w and klik_y<ile+1 and klik_y>0 and klik[3] == 1) then
			if fs.isDir(fs.combine(sciezka,arg[klik_y])) then
				sciezka = fs.combine(sciezka,arg[klik_y])
				main(sciezka)
			else
				if fs.exists(fs.combine(sciezka,arg[klik_y])) then
					tc()
					local status, err = pcall(shell.run(arg[klik_y]))
						if status == false then
							logi = fs.open("/os/logs", "a")
							logi.writeLine("------")
							logi.writeLine(arg[klik_y])
							logi.writeLine(status)
							logi.close()
							sbc(colors.black)
							tc()
							sbc(colors.black)
							stc(colors.white)
							scp(1,2)
							p[[Program zakonczyl prace. Jesli nie stalo sie to niespodziewanie, zignoruj ten komunikat. W przypadku problemow skontaktuj sie z autorem oprogramowania.]]
							s(2)
							break
						end
				end
			end
		end
	end
end
sciezka = "/"
shell.setDir("/")
while true do
if (args[1] == nil) then main(sciezka) else main(args[1]) end
end